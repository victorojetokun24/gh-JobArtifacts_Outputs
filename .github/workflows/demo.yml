name: Deploy website 
on: # Trigger workflow on pushes to the master branch
  push: # push events
    branches: # only for the master branch
      - master # master branch
jobs: # Define the jobs to run in this workflow
  test: # Define a job named "test"

    runs-on: ubuntu-latest # Use the latest Ubuntu runner
    outputs: # Define outputs for the "test" job
      script-file: ${{ steps.publish.outputs.script-file }} # Output the script filename from the publish step
    steps: # Define the steps for the "test" job
      - name: Get code # Step to checkout the repository code
        uses: actions/checkout@v3 # Use the checkout action

      - name: Use Node 18 # Step to set up Node.js environment
        uses: actions/setup-node@v4 # Use the setup-node action
        with: # Configuration for the setup-node action
          node-version: 18 # Use Node.js version 18
      - name: cache dependencies # Step to cache Node.js dependencies
        uses: actions/cache@v3 # Use the cache action
        with: # Configuration for the cache action
          path: ~/.npm # Cache the npm cache directory
          key: deps-node-modules-${{ hashFiles('**/package-lock.json') }} # Cache key based on package-lock.json
      - name: Install dependencies # Step to install project dependencies
        run: npm ci # Install dependencies using npm ci
      - name: Lint code # Step to lint the code
        run: npm run lint # Run linting script
      - name: Test code # Step to run tests
        run: npm run test # Run test script
  build: # Define a job named "build"
    needs: test # This job depends on the "test" job
    runs-on: ubuntu-latest # Use the latest Ubuntu runner
    steps: # Define the steps for the "build" job
      - name: Get code # Step to checkout the repository code
        uses: actions/checkout@v3 # Use the checkout action
      
      - name: cache dependencies # Step to cache Node.js dependencies
        uses: actions/cache@v3 # Use the cache action
        with: # Configuration for the cache action
          path: ~/.npm # Cache the npm cache directory
          key: deps-node-modules-${{ hashFiles('**/package-lock.json') }} # Cache key based on package-lock.json
      - name: Install dependencies # Step to install project dependencies
        run: npm ci # Install dependencies using npm ci
      - name: Build website # Step to build the website
        run: npm run build # Run build script
      - name: Debug build # 
        run: |
          echo "Listing project root:"
          ls -la
          echo "Listing dist:"
          ls -la dist || echo "âŒ dist folder NOT generated"

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: dist-files
          path: |
            dist
            "dist/**"
      - name: Publish JS Filename
        id: publish # Step to publish the JavaScript filename
        run: |
          FILE=$(find dist/assets/*.js -type f | head -1) # Find the built JS file
          echo "script-file=$FILE" >> $GITHUB_OUTPUT # Set the filename as an output
          # Alternative way to set output (deprecated)
          # find dist/assets/*.js -type f -execdir echo '::set-output name=script-file::{}' ';' # Find the built JS file and set it as an output
      - name: upload artifacts # Step to upload build artifacts
        uses: actions/upload-artifact@v4 # Use the upload-artifact action
        with: # Specify the artifact details
          name: dist-files # Name of the artifact
          path: | # Paths to include in the artifact
            dist/** # Include all files in the dist directory
            package.json # Include package.json file
            
  deploy: # Define a job named "deploy"
    needs: build # This job depends on the "build" job
    runs-on: ubuntu-latest # Use the latest Ubuntu runner
    steps: # Define the steps for the "deploy" job
      - name: Download artifacts # Step to download build artifacts
        uses: actions/download-artifact@v4 # Use the download-artifact action
        with: # Specify the artifact details
          name: dist-files # Name of the artifact to download
          path: dist # Download to the dist directory
      - name: List files or output contents for verification # Step to verify downloaded artifacts
        run: ls -la dist # List the contents of the dist directory

      - name: output filename # Step to output the script filename
        run: echo "${{ needs.build.outputs.script-file }}" # Output the script filename from the build job
      - name: Deploy website # Step to deploy the website
        run: echo "Deploying..." # Placeholder for deployment command


# commands run on the terminal of the node project before deployment
        # npm install
        # npm audit fix --force
        # npm run build
